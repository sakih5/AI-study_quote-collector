# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆæ›¸ v2.0

## 1. æ¦‚è¦

### 1.1 ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

- **PostgreSQL 15** (Supabase)
- æ–‡å­—ã‚³ãƒ¼ãƒ‰ï¼šUTF-8
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ï¼šUTC

### 1.2 è¨­è¨ˆæ–¹é‡

- æ­£è¦åŒ–ï¼šç¬¬3æ­£è¦å½¢ã¾ã§
- è«–ç†å‰Šé™¤ï¼š`deleted_at` ã‚«ãƒ©ãƒ ã§ç®¡ç†
- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼š`created_at`, `updated_at` ã‚’å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«é…ç½®
- Row Level Securityï¼ˆRLSï¼‰ï¼šSupabaseã§æœ‰åŠ¹åŒ–

---

## 2. ERå›³

```mermaid
erDiagram
  users ||--o{ books : "1:N"
  users ||--o{ sns_users : "1:N"
  users ||--o{ tags : "1:N"
  users ||--o{ quotes : "1:N"

  quotes }o--o{ activities : "N:M via quote_activities"
  quotes }o--o{ tags : "N:M via quote_tags"

  quotes }o--|| books : "N:1 source=BOOK"
  quotes }o--|| sns_users : "N:1 source=SNS"

  activities ||--o{ quote_activities : "1:N"
  tags ||--o{ quote_tags : "1:N"
  quotes ||--o{ quote_activities : "1:N"
  quotes ||--o{ quote_tags : "1:N"
```

---

## 3. ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

### 3.1 usersï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

**èª¬æ˜Ž:** Supabase AuthãŒç®¡ç†ã€‚ç›´æŽ¥æ“ä½œã—ãªã„ã€‚

```sql
-- Supabase Authã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå‚ç…§ã®ã¿ï¼‰
-- auth.users
id UUID PRIMARY KEY
email TEXT
created_at TIMESTAMPTZ
```

---

### 3.2 activitiesï¼ˆæ´»å‹•é ˜åŸŸï¼‰

**èª¬æ˜Ž:** ã‚·ã‚¹ãƒ†ãƒ å›ºå®šã®10å€‹ã®æ´»å‹•é ˜åŸŸãƒžã‚¹ã‚¿ã€‚

```sql
CREATE TABLE activities (
  id SERIAL PRIMARY KEY,
  name TEXT NOT NULL UNIQUE,
  description TEXT,
  icon TEXT NOT NULL,
  display_order INT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- åˆæœŸãƒ‡ãƒ¼ã‚¿
INSERT INTO activities (id, name, description, icon, display_order) VALUES
(1, 'ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢', 'æ¥­å‹™ã€ã‚¹ã‚­ãƒ«é–‹ç™ºã€ã‚­ãƒ£ãƒªã‚¢å½¢æˆã«é–¢é€£ã™ã‚‹æ´»å‹•', 'ðŸ’¼', 1),
(2, 'å­¦ç¿’ãƒ»ç ”ç©¶', 'å‹‰å¼·ã€èª¿æŸ»ã€çŸ¥è­˜ç¿’å¾—ã«é–¢ã™ã‚‹æ´»å‹•', 'ðŸ“–', 2),
(3, 'å‰µä½œãƒ»åˆ¶ä½œæ´»å‹•', 'åŸ·ç­†ã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€å·¥ä½œç­‰', 'ðŸŽ¨', 3),
(4, 'è¶£å‘³ãƒ»å¨¯æ¥½', 'ã‚²ãƒ¼ãƒ ã€éŸ³æ¥½é‘‘è³žã€æ˜ ç”»ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç­‰', 'ðŸŽ®', 4),
(5, 'é‹å‹•ãƒ»èº«ä½“æ´»å‹•', 'ã‚¹ãƒãƒ¼ãƒ„ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€æ•£æ­©ç­‰', 'ðŸƒ', 5),
(6, 'èª­æ›¸ãƒ»æƒ…å ±åŽé›†', 'æœ¬ã€è¨˜äº‹ã€SNSã€ãƒ‹ãƒ¥ãƒ¼ã‚¹ç­‰ã®é–²è¦§', 'ðŸ“š', 6),
(7, 'äººé–“é–¢ä¿‚ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'å®¶æ—ã€å‹äººã€åŒåƒšã¨ã®é–¢ã‚ã‚Š', 'ðŸ‘¥', 7),
(8, 'ç”Ÿæ´»ç¿’æ…£ãƒ»ã‚»ãƒ«ãƒ•ã‚±ã‚¢', 'ç¡çœ ã€é£Ÿäº‹ã€ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢ã€ç’°å¢ƒæ•´å‚™', 'ðŸŒ±', 8),
(9, 'ç¤¾ä¼šæ´»å‹•ãƒ»è²¢çŒ®', 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢ã€åœ°åŸŸæ´»å‹•ã€ç¤¾ä¼šèª²é¡Œã¸ã®å–ã‚Šçµ„ã¿', 'ðŸ¤', 9),
(10, 'ãã®ä»–', 'ä¸Šè¨˜ã«å½“ã¦ã¯ã¾ã‚‰ãªã„æ´»å‹•', 'ðŸ“', 10);

CREATE INDEX activities_display_order_idx ON activities(display_order);
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | SERIAL | NOT NULL | - | æ´»å‹•é ˜åŸŸIDï¼ˆå›ºå®šï¼‰ |
| name | TEXT | NOT NULL | - | æ´»å‹•é ˜åŸŸå |
| description | TEXT | NULL | - | èª¬æ˜Ž |
| icon | TEXT | NOT NULL | - | ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰ |
| display_order | INT | NOT NULL | - | è¡¨ç¤ºé †åº |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ |

---

### 3.3 booksï¼ˆæ›¸ç±ï¼‰

**èª¬æ˜Ž:** ãƒ•ãƒ¬ãƒ¼ã‚ºã®å‡ºå…¸ã¨ãªã‚‹æ›¸ç±æƒ…å ±ã€‚

```sql
CREATE TABLE books (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  author TEXT NOT NULL,
  cover_image_url TEXT,
  isbn TEXT,
  asin TEXT,
  publisher TEXT,
  publication_date DATE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  UNIQUE(user_id, title, author)
);

CREATE INDEX books_user_idx ON books(user_id) WHERE deleted_at IS NULL;
CREATE INDEX books_title_idx ON books(title) WHERE deleted_at IS NULL;
CREATE INDEX books_isbn_idx ON books(isbn) WHERE deleted_at IS NULL AND isbn IS NOT NULL;
CREATE INDEX books_asin_idx ON books(asin) WHERE deleted_at IS NULL AND asin IS NOT NULL;

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE books ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
CREATE POLICY books_policy ON books
  USING (auth.uid() = user_id);
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | BIGSERIAL | NOT NULL | - | æ›¸ç±ID |
| user_id | UUID | NOT NULL | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆSupabase Authï¼‰ |
| title | TEXT | NOT NULL | - | æ›¸ç±ã‚¿ã‚¤ãƒˆãƒ« |
| author | TEXT | NOT NULL | - | è‘—è€…å |
| cover_image_url | TEXT | NULL | - | æ›¸ç±ã‚«ãƒãƒ¼ç”»åƒURL |
| isbn | TEXT | NULL | - | ISBNï¼ˆå›½éš›æ¨™æº–å›³æ›¸ç•ªå·ï¼‰ |
| asin | TEXT | NULL | - | Amazon ASIN |
| publisher | TEXT | NULL | - | å‡ºç‰ˆç¤¾ |
| publication_date | DATE | NULL | - | å‡ºç‰ˆæ—¥ |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | now() | æ›´æ–°æ—¥æ™‚ |
| deleted_at | TIMESTAMPTZ | NULL | - | å‰Šé™¤æ—¥æ™‚ï¼ˆè«–ç†å‰Šé™¤ï¼‰ |

**åˆ¶ç´„:**

- `UNIQUE(user_id, title, author)`: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜æ›¸ç±ã‚’é‡è¤‡ç™»éŒ²ã§ããªã„

---

### 3.4 sns_usersï¼ˆSNSãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

**èª¬æ˜Ž:** ãƒ•ãƒ¬ãƒ¼ã‚ºã®å‡ºå…¸ã¨ãªã‚‹SNSãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‚

```sql
CREATE TABLE sns_users (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  platform TEXT NOT NULL CHECK (platform IN ('X', 'THREADS')),
  handle TEXT NOT NULL,
  display_name TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  UNIQUE(user_id, platform, handle)
);

CREATE INDEX sns_users_user_idx ON sns_users(user_id) WHERE deleted_at IS NULL;
CREATE INDEX sns_users_handle_idx ON sns_users(handle) WHERE deleted_at IS NULL;
CREATE INDEX sns_users_platform_idx ON sns_users(platform) WHERE deleted_at IS NULL;

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE sns_users ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼
CREATE POLICY sns_users_policy ON sns_users
  USING (auth.uid() = user_id);
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | BIGSERIAL | NOT NULL | - | SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ID |
| user_id | UUID | NOT NULL | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆSupabase Authï¼‰ |
| platform | TEXT | NOT NULL | - | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆX, THREADSï¼‰ |
| handle | TEXT | NOT NULL | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆ@ã¯å«ã¾ãªã„ï¼‰ |
| display_name | TEXT | NULL | - | è¡¨ç¤ºåï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰ |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | now() | æ›´æ–°æ—¥æ™‚ |
| deleted_at | TIMESTAMPTZ | NULL | - | å‰Šé™¤æ—¥æ™‚ï¼ˆè«–ç†å‰Šé™¤ï¼‰ |

**åˆ¶ç´„:**

- `CHECK (platform IN ('X', 'THREADS'))`: ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¯ X ã¾ãŸã¯ THREADS ã®ã¿
- `UNIQUE(user_id, platform, handle)`: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒãƒ³ãƒ‰ãƒ«ã‚’é‡è¤‡ç™»éŒ²ã§ããªã„

**å°†æ¥ã®æ‹¡å¼µ:**

```sql
-- æ–°ã—ã„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿½åŠ ã™ã‚‹å ´åˆ
ALTER TABLE sns_users
  DROP CONSTRAINT sns_users_platform_check,
  ADD CONSTRAINT sns_users_platform_check
    CHECK (platform IN ('X', 'THREADS', 'BLUESKY', 'MASTODON'));
```

---

### 3.5 tagsï¼ˆã‚¿ã‚°ï¼‰

**èª¬æ˜Ž:** ãƒ•ãƒ¬ãƒ¼ã‚ºã«ä»˜ä¸Žã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã‚¿ã‚°ã€‚

```sql
CREATE TABLE tags (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  UNIQUE(user_id, name)
);

CREATE INDEX tags_user_idx ON tags(user_id) WHERE deleted_at IS NULL;
CREATE INDEX tags_name_idx ON tags(name) WHERE deleted_at IS NULL;

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE tags ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼
CREATE POLICY tags_policy ON tags
  USING (auth.uid() = user_id);
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | BIGSERIAL | NOT NULL | - | ã‚¿ã‚°ID |
| user_id | UUID | NOT NULL | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆSupabase Authï¼‰ |
| name | TEXT | NOT NULL | - | ã‚¿ã‚°åï¼ˆ#å«ã‚€ï¼‰ |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ |
| updated_at | TIMESTAMPTZ | NOT NULL | now() | æ›´æ–°æ—¥æ™‚ |
| deleted_at | TIMESTAMPTZ | NULL | - | å‰Šé™¤æ—¥æ™‚ï¼ˆè«–ç†å‰Šé™¤ï¼‰ |

**åˆ¶ç´„:**

- `UNIQUE(user_id, name)`: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜ã‚¿ã‚°åã‚’é‡è¤‡ä½œæˆã§ããªã„

---

### 3.6 quotesï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºï¼‰

**èª¬æ˜Ž:** ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç™»éŒ²ã™ã‚‹ãƒ•ãƒ¬ãƒ¼ã‚ºæœ¬ä½“ã€‚

```sql
CREATE TABLE quotes (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  text TEXT NOT NULL,
  source_type TEXT NOT NULL CHECK (source_type IN ('BOOK', 'SNS', 'OTHER')),
  book_id BIGINT REFERENCES books(id) ON DELETE CASCADE,
  sns_user_id BIGINT REFERENCES sns_users(id) ON DELETE CASCADE,
  page_number INT,
  source_meta JSONB,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ,
  CONSTRAINT source_check CHECK (
    (source_type = 'BOOK' AND book_id IS NOT NULL AND sns_user_id IS NULL) OR
    (source_type = 'SNS' AND sns_user_id IS NOT NULL AND book_id IS NULL) OR
    (source_type = 'OTHER' AND book_id IS NULL AND sns_user_id IS NULL)
  )
);

CREATE INDEX quotes_user_idx ON quotes(user_id) WHERE deleted_at IS NULL;
CREATE INDEX quotes_source_type_idx ON quotes(source_type) WHERE deleted_at IS NULL;
CREATE INDEX quotes_book_idx ON quotes(book_id) WHERE deleted_at IS NULL;
CREATE INDEX quotes_sns_user_idx ON quotes(sns_user_id) WHERE deleted_at IS NULL;
CREATE INDEX quotes_created_idx ON quotes(created_at DESC) WHERE deleted_at IS NULL;
CREATE INDEX quotes_text_idx ON quotes USING gin(to_tsvector('japanese', text)) WHERE deleted_at IS NULL;

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE quotes ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼
CREATE POLICY quotes_policy ON quotes
  USING (auth.uid() = user_id);
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | BIGSERIAL | NOT NULL | - | ãƒ•ãƒ¬ãƒ¼ã‚ºID |
| user_id | UUID | NOT NULL | - | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆSupabase Authï¼‰ |
| text | TEXT | NOT NULL | - | ãƒ•ãƒ¬ãƒ¼ã‚ºæœ¬æ–‡ |
| source_type | TEXT | NOT NULL | - | å‡ºå…¸ã‚¿ã‚¤ãƒ—ï¼ˆBOOK, SNS, OTHERï¼‰ |
| book_id | BIGINT | NULL | - | æ›¸ç±IDï¼ˆsource_type='BOOK'ã®å ´åˆï¼‰ |
| sns_user_id | BIGINT | NULL | - | SNSãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆsource_type='SNS'ã®å ´åˆï¼‰ |
| page_number | INT | NULL | - | ãƒšãƒ¼ã‚¸ç•ªå·ï¼ˆæ›¸ç±ã®å ´åˆï¼‰ |
| source_meta | JSONB | NULL | - | è¿½åŠ ã®å‡ºå…¸æƒ…å ±ï¼ˆJSONã§ä¿å­˜ï¼‰ |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºç™»éŒ²æ—¥æ™‚ï¼‰ |
| updated_at | TIMESTAMPTZ | NOT NULL | now() | æ›´æ–°æ—¥æ™‚ |
| deleted_at | TIMESTAMPTZ | NULL | - | å‰Šé™¤æ—¥æ™‚ï¼ˆè«–ç†å‰Šé™¤ï¼‰ |

**åˆ¶ç´„:**

- `CHECK (source_type IN ('BOOK', 'SNS', 'OTHER'))`: å‡ºå…¸ã‚¿ã‚¤ãƒ—ã¯3ç¨®é¡žã®ã¿
- `source_check`: å‡ºå…¸ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦é©åˆ‡ãªå¤–éƒ¨ã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼

**source_metaã®æ§‹é€ :**

```json
// BOOK
{
  "page": 27
}

// SNS - ç‰¹ã«ãªã—ï¼ˆå°†æ¥çš„ã«æŠ•ç¨¿æ—¥æ™‚ãªã©ä¿å­˜å¯èƒ½ï¼‰
{}

// OTHER
{
  "source": "ç¤¾å†…ç ”ä¿®",
  "note": "10æœˆã®å…¨ç¤¾ç ”ä¿®ã§ã®æ°—ã¥ã"
}
```

---

### 3.7 quote_activitiesï¼ˆãƒ•ãƒ¬ãƒ¼ã‚º-æ´»å‹•é ˜åŸŸ ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**èª¬æ˜Ž:** ãƒ•ãƒ¬ãƒ¼ã‚ºã¨æ´»å‹•é ˜åŸŸã®å¤šå¯¾å¤šé–¢ä¿‚ã‚’ç®¡ç†ã€‚

```sql
CREATE TABLE quote_activities (
  id BIGSERIAL PRIMARY KEY,
  quote_id BIGINT NOT NULL REFERENCES quotes(id) ON DELETE CASCADE,
  activity_id INT NOT NULL REFERENCES activities(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(quote_id, activity_id)
);

CREATE INDEX quote_activities_quote_idx ON quote_activities(quote_id);
CREATE INDEX quote_activities_activity_idx ON quote_activities(activity_id);

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE quote_activities ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼ï¼šquotesçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
CREATE POLICY quote_activities_policy ON quote_activities
  USING (
    EXISTS (
      SELECT 1 FROM quotes
      WHERE quotes.id = quote_activities.quote_id
      AND quotes.user_id = auth.uid()
    )
  );
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | BIGSERIAL | NOT NULL | - | ID |
| quote_id | BIGINT | NOT NULL | - | ãƒ•ãƒ¬ãƒ¼ã‚ºID |
| activity_id | INT | NOT NULL | - | æ´»å‹•é ˜åŸŸID |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„:**

- `UNIQUE(quote_id, activity_id)`: åŒã˜ãƒ•ãƒ¬ãƒ¼ã‚ºã«åŒã˜æ´»å‹•é ˜åŸŸã‚’é‡è¤‡ã—ã¦ä»˜ä¸Žã§ããªã„

---

### 3.8 quote_tagsï¼ˆãƒ•ãƒ¬ãƒ¼ã‚º-ã‚¿ã‚° ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰

**èª¬æ˜Ž:** ãƒ•ãƒ¬ãƒ¼ã‚ºã¨ã‚¿ã‚°ã®å¤šå¯¾å¤šé–¢ä¿‚ã‚’ç®¡ç†ã€‚

```sql
CREATE TABLE quote_tags (
  id BIGSERIAL PRIMARY KEY,
  quote_id BIGINT NOT NULL REFERENCES quotes(id) ON DELETE CASCADE,
  tag_id BIGINT NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(quote_id, tag_id)
);

CREATE INDEX quote_tags_quote_idx ON quote_tags(quote_id);
CREATE INDEX quote_tags_tag_idx ON quote_tags(tag_id);

-- RLSæœ‰åŠ¹åŒ–
ALTER TABLE quote_tags ENABLE ROW LEVEL SECURITY;

-- ãƒãƒªã‚·ãƒ¼ï¼šquotesçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
CREATE POLICY quote_tags_policy ON quote_tags
  USING (
    EXISTS (
      SELECT 1 FROM quotes
      WHERE quotes.id = quote_tags.quote_id
      AND quotes.user_id = auth.uid()
    )
  );
```

**ã‚«ãƒ©ãƒ èª¬æ˜Ž:**

| ã‚«ãƒ©ãƒ å | åž‹ | NULL | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜Ž |
|---------|-----|------|-----------|------|
| id | BIGSERIAL | NOT NULL | - | ID |
| quote_id | BIGINT | NOT NULL | - | ãƒ•ãƒ¬ãƒ¼ã‚ºID |
| tag_id | BIGINT | NOT NULL | - | ã‚¿ã‚°ID |
| created_at | TIMESTAMPTZ | NOT NULL | now() | ä½œæˆæ—¥æ™‚ |

**åˆ¶ç´„:**

- `UNIQUE(quote_id, tag_id)`: åŒã˜ãƒ•ãƒ¬ãƒ¼ã‚ºã«åŒã˜ã‚¿ã‚°ã‚’é‡è¤‡ã—ã¦ä»˜ä¸Žã§ããªã„

---

## 4. ãƒ“ãƒ¥ãƒ¼

### 4.1 quotes_with_detailsï¼ˆãƒ•ãƒ¬ãƒ¼ã‚ºè©³ç´°ãƒ“ãƒ¥ãƒ¼ï¼‰

**èª¬æ˜Ž:** ãƒ•ãƒ¬ãƒ¼ã‚ºã¨é–¢é€£æƒ…å ±ã‚’çµåˆã—ãŸãƒ“ãƒ¥ãƒ¼ã€‚é »ç¹ã«ä½¿ç”¨ã™ã‚‹JOINã‚’ã¾ã¨ã‚ã‚‹ã€‚

```sql
CREATE VIEW quotes_with_details AS
SELECT
  q.id,
  q.user_id,
  q.text,
  q.source_type,
  q.page_number,
  q.source_meta,
  q.created_at,
  q.updated_at,
  -- æ›¸ç±æƒ…å ±
  b.id AS book_id,
  b.title AS book_title,
  b.author AS book_author,
  b.cover_image_url AS book_cover_image_url,
  -- SNSãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
  s.id AS sns_user_id,
  s.platform AS sns_platform,
  s.handle AS sns_handle,
  s.display_name AS sns_display_name,
  -- æ´»å‹•é ˜åŸŸï¼ˆé…åˆ—ï¼‰
  ARRAY_AGG(DISTINCT a.id) FILTER (WHERE a.id IS NOT NULL) AS activity_ids,
  ARRAY_AGG(DISTINCT a.name || ' ' || a.icon) FILTER (WHERE a.id IS NOT NULL) AS activity_names,
  -- ã‚¿ã‚°ï¼ˆé…åˆ—ï¼‰
  ARRAY_AGG(DISTINCT t.id) FILTER (WHERE t.id IS NOT NULL) AS tag_ids,
  ARRAY_AGG(DISTINCT t.name) FILTER (WHERE t.id IS NOT NULL) AS tag_names
FROM quotes q
LEFT JOIN books b ON q.book_id = b.id AND b.deleted_at IS NULL
LEFT JOIN sns_users s ON q.sns_user_id = s.id AND s.deleted_at IS NULL
LEFT JOIN quote_activities qa ON q.id = qa.quote_id
LEFT JOIN activities a ON qa.activity_id = a.id
LEFT JOIN quote_tags qt ON q.id = qt.quote_id
LEFT JOIN tags t ON qt.tag_id = t.id AND t.deleted_at IS NULL
WHERE q.deleted_at IS NULL
GROUP BY
  q.id, q.user_id, q.text, q.source_type, q.page_number, q.source_meta,
  q.created_at, q.updated_at,
  b.id, b.title, b.author, b.cover_image_url,
  s.id, s.platform, s.handle, s.display_name;
```

---

## 5. ãƒˆãƒªã‚¬ãƒ¼

### 5.1 updated_atè‡ªå‹•æ›´æ–°

**èª¬æ˜Ž:** ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°æ™‚ã« `updated_at` ã‚’è‡ªå‹•æ›´æ–°ã€‚

```sql
-- ãƒˆãƒªã‚¬ãƒ¼é–¢æ•°
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒˆãƒªã‚¬ãƒ¼ã‚’è¨­å®š
CREATE TRIGGER update_books_updated_at BEFORE UPDATE ON books
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_sns_users_updated_at BEFORE UPDATE ON sns_users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_tags_updated_at BEFORE UPDATE ON tags
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_quotes_updated_at BEFORE UPDATE ON quotes
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

---

## 6. ã‚¯ã‚¨ãƒªä¾‹

### 6.1 ãƒ•ãƒ¬ãƒ¼ã‚ºä¸€è¦§å–å¾—ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰

```sql
-- æ›¸ç±ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
SELECT
  b.id AS book_id,
  b.title,
  b.author,
  b.cover_image_url,
  json_agg(
    json_build_object(
      'id', q.id,
      'text', q.text,
      'page_number', q.page_number,
      'activities', q.activity_names,
      'tags', q.tag_names,
      'created_at', q.created_at
    )
  ) AS quotes
FROM quotes_with_details q
JOIN books b ON q.book_id = b.id
WHERE q.user_id = 'xxx-xxx-xxx'
  AND q.source_type = 'BOOK'
GROUP BY b.id, b.title, b.author, b.cover_image_url
ORDER BY MAX(q.created_at) DESC;

-- SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
SELECT
  s.id AS sns_user_id,
  s.platform,
  s.handle,
  s.display_name,
  json_agg(
    json_build_object(
      'id', q.id,
      'text', q.text,
      'activities', q.activity_names,
      'tags', q.tag_names,
      'created_at', q.created_at
    )
  ) AS quotes
FROM quotes_with_details q
JOIN sns_users s ON q.sns_user_id = s.id
WHERE q.user_id = 'xxx-xxx-xxx'
  AND q.source_type = 'SNS'
GROUP BY s.id, s.platform, s.handle, s.display_name
ORDER BY MAX(q.created_at) DESC;
```

### 6.2 ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢

```sql
SELECT * FROM quotes_with_details
WHERE user_id = 'xxx-xxx-xxx'
  AND (
    text ILIKE '%æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰%'
    OR book_title ILIKE '%æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰%'
    OR book_author ILIKE '%æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰%'
    OR sns_display_name ILIKE '%æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰%'
  )
ORDER BY created_at DESC;
```

### 6.3 æ´»å‹•é ˜åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

```sql
SELECT * FROM quotes_with_details
WHERE user_id = 'xxx-xxx-xxx'
  AND activity_ids @> ARRAY[1, 2]  -- æ´»å‹•é ˜åŸŸID 1 ã¾ãŸã¯ 2 ã‚’å«ã‚€
ORDER BY created_at DESC;
```

### 6.4 ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

```sql
SELECT * FROM quotes_with_details
WHERE user_id = 'xxx-xxx-xxx'
  AND tag_ids @> ARRAY[10, 20]  -- ã‚¿ã‚°ID 10 ã¾ãŸã¯ 20 ã‚’å«ã‚€
ORDER BY created_at DESC;
```

### 6.5 ã‚¿ã‚°çµ±åˆ

```sql
-- ã‚¿ã‚°ID 123 ã‚’ ã‚¿ã‚°ID 456 ã«çµ±åˆ
BEGIN;

-- quote_tagsã‚’æ›´æ–°
UPDATE quote_tags
SET tag_id = 456
WHERE tag_id = 123
ON CONFLICT (quote_id, tag_id) DO NOTHING;  -- é‡è¤‡ã¯ç„¡è¦–

-- å¤ã„ã‚¿ã‚°ã‚’å‰Šé™¤
UPDATE tags
SET deleted_at = now()
WHERE id = 123;

COMMIT;
```

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### 7.1 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

- å…¨æ–‡æ¤œç´¢ï¼š`quotes.text` ã« GIN ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- å¤–éƒ¨ã‚­ãƒ¼ï¼šã™ã¹ã¦ã®å¤–éƒ¨ã‚­ãƒ¼ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- æ¤œç´¢æ¡ä»¶ï¼š`deleted_at IS NULL` ã‚’å«ã‚€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- ã‚½ãƒ¼ãƒˆï¼š`created_at DESC` ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

### 7.2 N+1å•é¡Œå¯¾ç­–

- ãƒ“ãƒ¥ãƒ¼ `quotes_with_details` ã‚’ä½¿ç”¨ã—ã¦JOINã‚’äº‹å‰å®Ÿè¡Œ
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–å‡¦ç†

### 7.3 è«–ç†å‰Šé™¤ã®å½±éŸ¿

- å…¨ã‚¯ã‚¨ãƒªã« `WHERE deleted_at IS NULL` ã‚’å«ã‚ã‚‹
- éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§å‰Šé™¤æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–

---

## 8. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

### 8.1 Supabaseã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

- ç„¡æ–™ãƒ—ãƒ©ãƒ³ï¼š7æ—¥é–“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- Proãƒ—ãƒ©ãƒ³ï¼š30æ—¥é–“ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

### 8.2 æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—

```bash
# PostgreSQLãƒ€ãƒ³ãƒ—
pg_dump -h db.xxx.supabase.co -U postgres -d postgres > backup.sql

# å¾©å…ƒ
psql -h db.xxx.supabase.co -U postgres -d postgres < backup.sql
```

---

## 9. ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†

### 9.1 ãƒ„ãƒ¼ãƒ«

- Supabase CLI
- ã¾ãŸã¯æ‰‹å‹•SQLã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### 9.2 ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹

```sql
-- 001_create_initial_schema.sql
-- 002_add_activities_table.sql
-- 003_add_sns_users_table.sql
```

---

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 10.1 Row Level Securityï¼ˆRLSï¼‰

- ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§RLSã‚’æœ‰åŠ¹åŒ–
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½

### 10.2 æš—å·åŒ–

- SupabaseãŒæä¾›ã™ã‚‹æš—å·åŒ–ï¼ˆat rest, in transitï¼‰

---

## 11. å¤‰æ›´å±¥æ­´

| ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ—¥ä»˜ | å¤‰æ›´å†…å®¹ | æ‹…å½“è€… |
|-----------|------|----------|--------|
| 1.0 | 2024-10-27 | åˆç‰ˆä½œæˆ | - |
| 2.0 | 2024-10-27 | æ´»å‹•é ˜åŸŸã‚’10å€‹ã«å›ºå®šã€profile_image_urlå‰Šé™¤ã€ã‚¢ã‚¤ã‚³ãƒ³ç”»åƒä¸è¦ | - |
