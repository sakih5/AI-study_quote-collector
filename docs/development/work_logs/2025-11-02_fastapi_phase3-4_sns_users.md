# FastAPI Phase 3-4: /api/sns-users å®Ÿè£…ä½œæ¥­ãƒ­ã‚°

**ä½œæ¥­æ—¥**: 2025-11-02
**ä½œæ¥­è€…**: sakih
**ä½œæ¥­æ™‚é–“**: ç´„1.5æ™‚é–“
**çŠ¶æ…‹**: âœ… å®Œäº†

---

## ğŸ“‹ ä½œæ¥­æ¦‚è¦

FastAPIç§»è¡Œã®Phase 3-4ã¨ã—ã¦ã€SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†API `/api/sns-users` ã®å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¾ã—ãŸã€‚
Phase 3-3ï¼ˆbooksAPIï¼‰ã§ç¢ºç«‹ã—ãŸå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨ã—ã€ã‚¹ãƒ ãƒ¼ã‚ºã«å®Ÿè£…ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

---

## âœ… å®Œäº†ã—ãŸä½œæ¥­

### 1. Pydanticãƒ¢ãƒ‡ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/models/sns_user.py`

ä»¥ä¸‹ã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆï¼š
- `SnsUser`: åŸºæœ¬SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¢ãƒ‡ãƒ«
- `SnsUserCreate`: SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- `SnsUsersResponse`: SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆsns_users, total, has_moreï¼‰
- `SnsUserResponse`: SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹

**ãƒã‚¤ãƒ³ãƒˆ**:
- Next.jså´ã®APIã¨åŒã˜ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¶­æŒ
- `Literal["X", "THREADS"]` ã§ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å‹å®‰å…¨ã«å®šç¾©
- Fieldãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ï¼ˆmin_length, max_lengthï¼‰

---

### 2. APIãƒ«ãƒ¼ãƒˆä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/routes/sns_users.py`

å®Ÿè£…ã—ãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼š
1. **GET /api/sns-users** - SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§å–å¾—ï¼ˆâœ… å‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
   - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆlimit, offsetï¼‰
   - ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆX, THREADSï¼‰
   - æ¤œç´¢æ©Ÿèƒ½ï¼ˆhandle, display_nameï¼‰
   - ã‚½ãƒ¼ãƒˆï¼ˆcreated_até™é †ï¼‰
2. **POST /api/sns-users** - SNSãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆâœ… å‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
   - é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆplatform + handleï¼‰
   - Phase 3-3ã§ç¢ºç«‹ã—ãŸå›é¿ç­–ã‚’é©ç”¨

**å®Ÿè£…ã—ãŸæ©Ÿèƒ½**:
- ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆX, THREADSï¼‰
- æ¤œç´¢æ©Ÿèƒ½ï¼ˆãƒãƒ³ãƒ‰ãƒ«ãƒ»è¡¨ç¤ºåã§éƒ¨åˆ†ä¸€è‡´ï¼‰
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆlimit: 1-100, offset: 0ä»¥ä¸Šï¼‰
- é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ»ãƒãƒ³ãƒ‰ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯409ã‚¨ãƒ©ãƒ¼ï¼‰
- insertå¾Œã«åˆ¥é€”selectã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œï¼ˆsupabase-pyå•é¡Œã®å›é¿ï¼‰

---

### 3. Phase 3-3ã§ç¢ºç«‹ã—ãŸå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©ç”¨

**æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³**:
```python
# ã¾ãšinsertã‚’å®Ÿè¡Œ
insert_response = supabase.table('sns_users').insert(data).execute()
sns_user_id = insert_response.data[0]['id']

# åˆ¥é€”selectã‚¯ã‚¨ãƒªã§å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
select_response = supabase.table('sns_users') \
    .select('*') \
    .eq('id', sns_user_id) \
    .execute()
```

**åŠ¹æœ**:
- supabase-pyã®`.insert().select()`ãƒã‚§ãƒ¼ãƒ³å•é¡Œã‚’å›é¿
- RLSå¯¾å¿œæ¸ˆã¿ï¼ˆ`auth.py`ãŒèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šæ¸ˆã¿ï¼‰
- ã‚¨ãƒ©ãƒ¼ãªãã‚¹ãƒ ãƒ¼ã‚ºã«å®Ÿè£…å®Œäº†

---

### 4. main.pyã¸ãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²

**ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/main.py`

```python
from routes import activities, tags, books, sns_users

app.include_router(activities.router)
app.include_router(tags.router)
app.include_router(books.router)
app.include_router(sns_users.router)
```

---

### 5. å‹•ä½œç¢ºèª

#### 5-1. Swagger UIãƒ†ã‚¹ãƒˆ

**GET /api/sns-users**:
```json
{
  "sns_users": [],
  "total": 0,
  "has_more": false
}
```
âœ… æˆåŠŸï¼ˆåˆæœŸçŠ¶æ…‹ï¼šSNSãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã—ï¼‰

**POST /api/sns-users**:
```json
// ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
{
  "platform": "X",
  "handle": "elonmusk",
  "display_name": "Elon Musk"
}

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ201 Createdï¼‰
{
  "sns_user": {
    "id": 1,
    "user_id": "26c01d9c-69dd-40ff-b561-fe39c2798ac8",
    "platform": "X",
    "handle": "elonmusk",
    "display_name": "Elon Musk",
    "created_at": "2025-11-02T...",
    "updated_at": "2025-11-02T..."
  }
}
```
âœ… æˆåŠŸ

**GET /api/sns-usersï¼ˆå†å®Ÿè¡Œï¼‰**:
âœ… æˆåŠŸï¼ˆç™»éŒ²ã—ãŸSNSãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå–å¾—ã§ãã‚‹ï¼‰

---

#### 5-2. Next.jsã‹ã‚‰ã®å‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ

**ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ**:
```javascript
// ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
const tokenRes = await fetch('/api/get-token');
const { access_token } = await tokenRes.json();

// FastAPI /api/sns-users ã‚’å‘¼ã³å‡ºã—
const snsUsersRes = await fetch('http://localhost:8000/api/sns-users', {
  headers: { 'Authorization': `Bearer ${access_token}` }
});
const snsUsersData = await snsUsersRes.json();
console.log('FastAPI sns-users:', snsUsersData);

// Next.jsæ—¢å­˜APIã¨æ¯”è¼ƒ
const nextjsRes = await fetch('/api/sns-users');
const nextjsData = await nextjsRes.json();
console.log('Next.js sns-users:', nextjsData);
```

**çµæœ**:
âœ… æˆåŠŸï¼ˆFastAPIã¨Next.jsã§åŒã˜ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã‚‹ï¼‰

---

## ğŸ“Š é€²æ—çŠ¶æ³

### å®Œäº†ã—ãŸãƒ•ã‚§ãƒ¼ã‚º

| Phase | ã‚¿ã‚¹ã‚¯ | é€²æ— | çŠ¶æ…‹ |
|-------|--------|------|------|
| Phase 1 | ç’°å¢ƒæ§‹ç¯‰ | 100% | âœ… å®Œäº† |
| Phase 2 | èªè¨¼åŸºç›¤ | 100% | âœ… å®Œäº† |
| Phase 3-1 | /api/activities | 100% | âœ… å®Œäº† |
| Phase 3-2 | /api/tags | 40% | âš ï¸ ãƒ–ãƒ­ãƒƒã‚¯ä¸­ |
| Phase 3-3 | /api/books | 100% | âœ… å®Œäº† |
| Phase 3-4 | /api/sns-users | 100% | âœ… å®Œäº† |

**Phase 3-4å®Œäº†ï¼**

---

## ğŸ’¡ å­¦ã‚“ã ã“ã¨

### 1. ç¢ºç«‹ã•ã‚ŒãŸå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å¨åŠ›

**Phase 3-3ã§ç¢ºç«‹ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³**:
- insertå¾Œã«åˆ¥é€”selectã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
- RLSå¯¾å¿œã®ãŸã‚`auth.py`ã§èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®š

**åŠ¹æœ**:
- Phase 3-4ã§ã¯ã‚¨ãƒ©ãƒ¼ãªãã‚¹ãƒ ãƒ¼ã‚ºã«å®Ÿè£…
- ãƒ‡ãƒãƒƒã‚°æ™‚é–“ãŒå¤§å¹…ã«çŸ­ç¸®
- åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ã„å›ã›ã‚‹ãŸã‚ã€å®Ÿè£…é€Ÿåº¦ãŒå‘ä¸Š

---

### 2. FastAPIã®é–‹ç™ºä½“é¨“

**ãƒ¡ãƒªãƒƒãƒˆ**:
- Pydanticã®`Literal`å‹ã§å‹å®‰å…¨æ€§ã‚’ç¢ºä¿
- Swagger UIã§å³åº§ã«ãƒ†ã‚¹ãƒˆå¯èƒ½
- è‡ªå‹•ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã§ä»•æ§˜ãŒæ˜ç¢º

**Phase 3-4ã§ã®ä½“é¨“**:
- ãƒ¢ãƒ‡ãƒ«ä½œæˆ â†’ ãƒ«ãƒ¼ãƒˆä½œæˆ â†’ å‹•ä½œç¢ºèªã®æµã‚ŒãŒã‚¹ãƒ ãƒ¼ã‚º
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã‹ã£ãŸãŸã‚ã€äºˆå®šã‚ˆã‚Šæ—©ãå®Œäº†

---

### 3. Next.js APIã¨ã®äº’æ›æ€§

**ç¢ºèªã§ããŸã“ã¨**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ãŒå®Œå…¨ã«ä¸€è‡´
- ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚‚ä¸€è‡´
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¿®æ­£ãªã—ã§åˆ‡ã‚Šæ›¿ãˆå¯èƒ½

**Phase 3-3ã¨åŒæ§˜**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚­ãƒ¼åã‚’ä¸€è‡´ã•ã›ã‚‹ï¼ˆ`sns_users`, `total`, `has_more`ï¼‰
- ãƒ‡ãƒ¼ã‚¿å‹ã‚’ä¸€è‡´ã•ã›ã‚‹ï¼ˆdatetime â†’ ISO 8601æ–‡å­—åˆ—ï¼‰

---

## ğŸ¯ æ¬¡å›ã®ä½œæ¥­äºˆå®š

### Phase 3-5: /api/quotes ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…ï¼ˆæœ€çµ‚ï¼‰

**å®Ÿè£…å†…å®¹**ï¼ˆè¦‹ç©ã‚‚ã‚Š: 4ã€œ5æ™‚é–“ï¼‰:
1. Pydanticãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆ`backend/models/quote.py`ï¼‰
2. APIãƒ«ãƒ¼ãƒˆä½œæˆï¼ˆ`backend/routes/quotes.py`ï¼‰
3. CRUDæ“ä½œå®Ÿè£…
   - GET /api/quotes/groupedï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–ä¸€è¦§ï¼‰
   - POST /api/quotesï¼ˆä¸€æ‹¬ç™»éŒ²ï¼‰
   - PUT /api/quotes/{id}ï¼ˆæ›´æ–°ï¼‰
   - DELETE /api/quotes/{id}ï¼ˆå‰Šé™¤ï¼‰
4. è¤‡é›‘ãªã‚¯ã‚¨ãƒªã®å®Ÿè£…
   - å‡ºå…¸åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆbooks, sns_users, otherï¼‰
   - ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆkeyword, activity_ids, tag_idsï¼‰
5. å‹•ä½œç¢ºèªï¼ˆSwagger UI â†’ Next.jsï¼‰

**Phase 3-3/3-4ã§ç¢ºç«‹ã—ãŸå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é©ç”¨**:
- insertå¾Œã«åˆ¥é€”selectã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
- RLSå¯¾å¿œæ¸ˆã¿ï¼ˆ`auth.py`ãŒèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¨­å®šï¼‰

**æ³¨æ„ç‚¹**:
- ãƒ•ãƒ¬ãƒ¼ã‚ºç™»éŒ²ã¯è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã«é–¢é€£ä»˜ã‘ãŒå¿…è¦ï¼ˆquotes, quote_activities, quote_tagsï¼‰
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³çš„ãªå‡¦ç†ãŒå¿…è¦
- ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã‚¯ã‚¨ãƒªã¯è¤‡é›‘ã«ãªã‚‹å¯èƒ½æ€§

---

## ğŸ“ ä½œæˆãƒ»æ›´æ–°ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«

### æ–°è¦ä½œæˆ

```
backend/
â”œâ”€â”€ models/
â”‚   â””â”€â”€ sns_user.py          # Pydanticãƒ¢ãƒ‡ãƒ«
â””â”€â”€ routes/
    â””â”€â”€ sns_users.py         # APIãƒ«ãƒ¼ãƒˆ
```

### æ›´æ–°

```
backend/
â””â”€â”€ main.py                  # sns_usersãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²
```

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

```
docs/development/work_logs/
â””â”€â”€ 2025-11-02_fastapi_phase3-4_sns_users.md  # æœ¬ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## ğŸ”§ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚«ãƒ†ã‚´ãƒª | ãƒ©ã‚¤ãƒ–ãƒ©ãƒª | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | çŠ¶æ…‹ |
|---------|----------|-----------|------|
| Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | FastAPI | 0.104.1 | âœ… æ­£å¸¸ |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | Pydantic | 2.5.0 | âœ… æ­£å¸¸ |
| Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ | supabase-py | 2.0.0 | âœ… å›é¿ç­–ç¢ºç«‹ |

---

## ğŸ“ ãƒ¡ãƒ¢ãƒ»æ°—ã¥ã

1. **å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å†åˆ©ç”¨**
   - Phase 3-3ã§ç¢ºç«‹ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ãŒéå¸¸ã«æœ‰åŠ¹
   - ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„ãŸã‚ã€é–‹ç™ºé€Ÿåº¦ãŒå‘ä¸Š
   - åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’Phase 3-5ã§ã‚‚é©ç”¨å¯èƒ½

2. **Pydantic Literalã®å‹å®‰å…¨æ€§**
   - `Literal["X", "THREADS"]` ã§ä¸æ­£ãªå€¤ã‚’é˜²æ­¢
   - Swagger UIã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³é¸æŠãŒå¯èƒ½
   - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãŒæ˜ç¢º

3. **FastAPIã®é–‹ç™ºä½“é¨“**
   - Swagger UIã§ã®å³åº§ã®ãƒ†ã‚¹ãƒˆãŒéå¸¸ã«ä¾¿åˆ©
   - ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ˜ç¢ºã§å•é¡Œç‰¹å®šãŒå®¹æ˜“
   - Next.jsã¨ã®äº’æ›æ€§ã‚‚å•é¡Œãªã—

4. **Phase 3-4ã®æ‰€è¦æ™‚é–“**
   - äºˆå®š: 2ã€œ3æ™‚é–“
   - å®Ÿéš›: ç´„1.5æ™‚é–“
   - ã‚¨ãƒ©ãƒ¼ãŒãªã‹ã£ãŸãŸã‚ã€äºˆå®šã‚ˆã‚Šæ—©ãå®Œäº†

---

## ğŸš€ æ¬¡å›ã®é–‹å§‹æ–¹æ³•

æ¬¡å›ä½œæ¥­ã‚’å†é–‹ã™ã‚‹éš›ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ãã ã•ã„ï¼š

### FastAPIèµ·å‹•

```bash
cd /home/sakih/projects/AI-study_quote-collector/backend
source .venv/bin/activate
uvicorn main:app --reload --port 8000
```

### Next.jsèµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ï¼‰

```bash
cd /home/sakih/projects/AI-study_quote-collector
npm run dev
```

### Swagger UIã‚¢ã‚¯ã‚»ã‚¹

```
http://localhost:8000/docs
```

### ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰

```javascript
fetch('/api/get-token').then(res => res.json()).then(data => {
  console.log('ãƒˆãƒ¼ã‚¯ãƒ³:', data.access_token);
  navigator.clipboard.writeText(data.access_token);
});
```

---

**ä½œæˆæ—¥**: 2025-11-02
**æœ€çµ‚æ›´æ–°**: 2025-11-02
**FastAPI Phase 3-4 å®Œäº†ï¼**
**æ¬¡å›ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: Phase 3-5 (/api/quotes) ã®å®Ÿè£…ï¼ˆæœ€çµ‚ï¼‰
