# 修正計画書

**作成日**: 2025年11月04日
**ステータス**: 📝 計画中
**推定作業時間**: 11.25〜17時間

---

## 修正要望一覧

### 1. 件数カウント方法修正

- **現状**: グループ化されたフレーズのグループ数をカウント
- **要望**: フレーズ1つずつをカウントして表示

### 2. 見た目の修正

- ダークテーマ → ライトテーマに変更
- フレーズの文字サイズを大きく＆太字に
- 本のタイトルと著者名をグレーで目立たなくする
- フレーズをカードで囲い、影をつけて浮き出るように
- 本のタイトルと著者名を本の画像の下に配置し、文字サイズを小さくする

### 3. ログイン前画面の作成

- ログイン前の画面で公開モードの他者のフレーズをランダム表示
- ユーザーがログインしなくても何ができるか分かるようにする
- **実装方針**: オプションA - `quotes`テーブルに`is_public`フラグを追加
- フレーズ登録モーダルで公開/非公開を選択可能に

### 4. OCR文字抽出の修正

- OCRで抽出した文章から半角・全角スペースを除去
- OCRの部分選択をSnipping Tool風に変更（ドラッグしてなぞると青いマーカーで選択）

### 5. キーワード検索の修正

- 著者名での部分一致検索を追加
- 文字入力後、検索ボタンを押さなくても自動で絞り込み開始（リアルタイム検索）
- 検索ボタンを削除
- 文字入力を消すと該当件数が絞り込み前のものに戻る

### 6. 使用技術の修正（バックエンドPython統一）

- `lib/`配下のファイルをPythonで書き換え
- 既存の`lib/`は`lib_old/`に退避（TypeScript版に戻せるように）
- バックエンドをPythonに統一
- Next.jsからSupabaseへは全てFastAPI経由でアクセス

### 7. Amazon表紙画像取得

- Amazon URLから本の表紙画像を取得
- **実装方針**: オプションA - Amazon画像URLを直接保存（完全無料、実装簡単）
- 画像サイズはUIで問題ない程度に粗くてOK

---

## 実装計画（フェーズ別）

### **フェーズ1: 優先度高（1, 2, 7）** ⏱️ 2〜3時間

#### タスク1: 件数カウント方法修正（30分）

**対象ファイル**:

- `app/api/quotes/grouped/route.ts`
- フロントエンドの表示コンポーネント

**実装内容**:

- APIレスポンスにフレーズ総数を追加
- グループ数ではなくフレーズ総数をカウント
- フロントエンドで件数表示を更新

---

#### タスク2-1: ダークテーマ→ライトテーマ（15分）

**対象ファイル**:

- `app/globals.css`
- `tailwind.config.ts`（必要に応じて）

**実装内容**:

- 背景色を白系に変更
- テキスト色を黒系に変更
- ヘッダー・ナビゲーションの色調整

---

#### タスク2-2: フレーズのスタイル修正（30分）

**対象ファイル**:

- `app/(main)/components/QuoteGroupCard.tsx`

**実装内容**:

- フレーズをカード化（border, rounded, shadow追加）
- フレーズの文字サイズを大きく（`text-lg` → `text-xl`等）
- フレーズを太字に（`font-bold`）
- カードに影を追加（`shadow-md` や `shadow-lg`）

---

#### タスク2-3: 本タイトル・著者名のスタイル修正（15分）

**対象ファイル**:

- `app/(main)/components/QuoteGroupCard.tsx`

**実装内容**:

- 本タイトル・著者名をグレーに（`text-gray-500`）
- 文字サイズを小さく（`text-sm`）
- 本の画像の下に配置（レイアウト変更）

---

#### タスク7: Amazon表紙画像取得（30分〜1時間）

**対象ファイル**:

- `backend/routes/books.py`（既存）
- `backend/utils/scraping.py`（新規作成の可能性）
- `app/(main)/components/QuoteGroupCard.tsx`

**実装内容**:

1. バックエンド:
   - Amazonページから`<img id="landingImage">`のsrc属性を抽出
   - `cover_image_url`として保存
   - エラーハンドリング（画像が取得できない場合）

2. フロントエンド:
   - `cover_image_url`が存在する場合のみ画像表示
   - Next.js `<Image>`コンポーネントで表示
   - 画像がない場合のフォールバック表示

---

### **フェーズ2: 中優先度（5）** ⏱️ 1〜1.5時間

#### タスク5-1: 著者名での部分一致検索（30分）

**対象ファイル**:

- `backend/routes/quotes.py` (FastAPI)
- `app/api/quotes/grouped/route.ts` (Next.js API - 将来削除予定)

**実装内容**:

- SQLクエリに著者名検索を追加
- `WHERE (text ILIKE %keyword% OR book.author ILIKE %keyword%)`
- バックエンド・フロントエンド両方で対応

---

#### タスク5-2: リアルタイム絞り込み実装（30分）

**対象ファイル**:

- `app/(main)/page.tsx`
- `app/(main)/hooks/useQuotesGrouped.ts`

**実装内容**:

- 検索ボタンを削除
- `onChange`イベントで検索実行
- デバウンス処理（300ms程度）でAPI呼び出しを最適化
- `lodash.debounce`または`use-debounce`ライブラリ使用

---

#### タスク5-3: 入力クリア時の件数リセット（15分）

**対象ファイル**:

- `app/(main)/hooks/useQuotesGrouped.ts`

**実装内容**:

- 検索キーワードが空になった時の処理
- 件数を全体の件数にリセット
- フィルターをクリア

---

### **フェーズ3: OCR修正（4）** ⏱️ 2〜3時間

#### タスク4-1: スペース除去（15分）

**対象ファイル**:

- `lib/ocr/tesseract.ts` (現在)
- `backend/routes/ocr.py` (Python移行後)

**実装内容**:

- OCR結果から半角スペース（` `）と全角スペース（`　`）を除去
- 正規表現: `text.replace(/[\s　]/g, '')`（TypeScript）
- Python: `text.replace(' ', '').replace('　', '')`

---

#### タスク4-2: なぞり選択UI実装（2〜2.5時間）

**対象ファイル**:

- `app/(main)/components/OCRCanvas.tsx`
- `lib/ocr/tesseract.ts`（選択ロジック）

**実装内容**:

1. **ドラッグ選択UI**:
   - マウスダウン → ドラッグ → マウスアップ
   - ドラッグ中は青い半透明オーバーレイを表示
   - 選択範囲内の単語をハイライト

2. **選択ロジック**:
   - ドラッグパス上の単語を検出
   - 選択された単語に青いマーカー（`background: rgba(0, 123, 255, 0.3)`）
   - 複数選択対応（Shift+ドラッグで追加選択）

3. **既存の矩形選択**:
   - 削除または非表示（ユーザー確認が必要）

---

### **フェーズ4: 公開機能（3）** ⏱️ 2〜3時間

#### タスク3-1: DB修正（30分）

**対象ファイル**:

- `supabase/migrations/YYYYMMDD_add_is_public_to_quotes.sql`（新規）

**実装内容**:

```sql
-- quotes テーブルに is_public カラム追加
ALTER TABLE quotes
ADD COLUMN is_public BOOLEAN NOT NULL DEFAULT false;

-- インデックス追加（公開フレーズの検索を高速化）
CREATE INDEX idx_quotes_is_public ON quotes(is_public) WHERE is_public = true AND deleted_at IS NULL;

-- コメント追加
COMMENT ON COLUMN quotes.is_public IS 'フレーズの公開/非公開フラグ（true: 公開、false: 非公開）';
```

**手順**:

1. マイグレーションファイル作成
2. Supabaseダッシュボードで実行
3. 既存データは全て`is_public = false`

---

#### タスク3-2: フレーズ登録モーダル修正（30分）

**対象ファイル**:

- `app/(main)/components/QuoteModal.tsx`
- `backend/routes/quotes.py`
- `backend/models/quote.py`

**実装内容**:

1. **フロントエンド**:
   - トグルスイッチまたはチェックボックスで公開/非公開選択
   - デフォルトは非公開
   - UIは登録モーダルの下部に配置

2. **バックエンド**:
   - `QuoteCreate`モデルに`is_public`フィールド追加
   - POST/PUTリクエストで受け取り保存

---

#### タスク3-3: ログイン前画面実装（1〜2時間）

**対象ファイル**:

- `app/page.tsx`（既存のルートページ）
- `backend/routes/quotes.py`（新規エンドポイント）

**実装内容**:

1. **バックエンド**:
   - `GET /api/quotes/public`エンドポイント作成
   - `is_public = true`のフレーズをランダムに20〜30件取得
   - 認証不要（Depends削除）

2. **フロントエンド**:
   - `app/page.tsx`で公開フレーズを表示
   - グループ化表示（書籍・SNSユーザー別）
   - 「ログインして自分のフレーズを登録」ボタン
   - ヘッダーに「ログイン」ボタン表示

3. **ルーティング調整**:
   - `/` → ログイン前画面（公開フレーズ表示）
   - `/app` → ログイン後画面（自分のフレーズ管理）
   - `middleware.ts`の調整が必要

---

### **フェーズ5: Python化（6）** ⏱️ 4〜6時間

#### タスク6-1: lib/退避（5分）

**実施内容**:

```bash
mv lib lib_old
```

**対象**:

- `lib/ocr/`
- `lib/scraping/`
- `lib/supabase/`
- `lib/utils/`

**注意**:

- 完全に削除はせず、`lib_old/`に退避
- TypeScript版に戻す必要がある場合に備える

---

#### タスク6-2: Python版OCR実装（2時間）

**対象ファイル**:

- `backend/routes/ocr.py`（新規）
- `backend/requirements.txt`（依存追加）

**実装内容**:

1. **依存パッケージ**:
   - `pytesseract`
   - `Pillow` (PIL)
   - Tesseract本体のインストール（Cloud Run Dockerfileに追加）

2. **エンドポイント**:
   - `POST /api/ocr/extract` - 画像アップロード→テキスト抽出
   - リクエスト: `multipart/form-data`（画像ファイル）
   - レスポンス: OCR結果（単語リスト＋座標）

3. **Docker対応**:
   - `backend/Dockerfile`にTesseractインストール追加

   ```dockerfile
   RUN apt-get update && apt-get install -y tesseract-ocr tesseract-ocr-jpn
   ```

---

#### タスク6-3: Python版スクレイピング実装（1時間）

**対象ファイル**:

- `backend/utils/scraping.py`（新規）
- `backend/routes/books.py`（既存を更新）
- `backend/routes/sns_users.py`（既存を更新）

**実装内容**:

1. **Amazon書籍情報取得**:
   - `requests` + `BeautifulSoup`
   - ASIN抽出 → ページ取得 → タイトル・著者・表紙画像抽出
   - レート制限（10 req/min）

2. **SNS URL解析**:
   - X/Threads URLからハンドル抽出
   - （表示名取得は保留）

3. **既存TypeScriptコードの移植**:
   - `lib/scraping/amazon.ts` → Python
   - `lib/scraping/sns-url-parser.ts` → Python
   - `lib/scraping/rate-limiter.ts` → Python

---

#### タスク6-4: Python版CSV生成実装（30分）

**対象ファイル**:

- `backend/routes/export.py`（新規）

**実装内容**:

1. **エンドポイント**:
   - `GET /api/export/csv`
   - クエリパラメータでフィルター条件を受け取る
   - BOM付きUTF-8で出力

2. **実装**:
   - Pythonの`csv`モジュール使用
   - フレーズ・出典・活動領域・タグをCSV出力
   - エスケープ処理（カンマ、改行、ダブルクォート）

---

#### タスク6-5: Next.js参照削除（1〜1.5時間）

**対象ファイル**:

- `app/(main)/components/QuoteModal.tsx`
- その他、`lib/`をimportしている全ファイル

**実装内容**:

1. **import文の削除**:
   - `lib/ocr/tesseract`
   - `lib/scraping/*`
   - `lib/supabase/client`（認証のみ残す）
   - `lib/utils/csv-export`

2. **FastAPI経由に変更**:
   - OCR: `POST /api/ocr/extract`
   - スクレイピング: 既存のFastAPIエンドポイント
   - CSV: `GET /api/export/csv`

3. **動作確認**:
   - 各機能が正常に動作することを確認
   - エラーハンドリング確認

---

## 実装順序まとめ

1. 🚨 **フェーズ0開始** - Vercelログインリダイレクト修正（15〜30分）【緊急】
2. **フェーズ1** - 件数カウント、見た目修正、表紙画像取得（2〜3時間）
3. **フェーズ2** - キーワード検索修正（1〜1.5時間）
4. **フェーズ3** - OCR修正（2〜3時間）
5. **フェーズ4** - 公開機能（2〜3時間）
6. **フェーズ5** - Python化（4〜6時間）

---

## 推定時間まとめ

| フェーズ | 内容 | 推定時間 |
|---------|------|----------|
| フェーズ0 | Vercelログインリダイレクト修正 | 15〜30分 |
| フェーズ1 | 件数カウント、見た目修正、表紙画像 | 2〜3時間 |
| フェーズ2 | キーワード検索修正 | 1〜1.5時間 |
| フェーズ3 | OCR修正 | 2〜3時間 |
| フェーズ4 | 公開機能 | 2〜3時間 |
| フェーズ5 | Python化 | 4〜6時間 |
| **合計** | | **11.25〜17時間** |

---

## 技術的な検討事項

### 1. なぞり選択UI（タスク4-2）

- **課題**: Snipping Tool風のなぞり選択は実装が複雑
- **代替案**: 既存の矩形選択を残しつつ、新UIを追加
- **要確認**: ユーザーの優先度・期待する動作

### 2. ログイン前画面のルーティング（タスク3-3）

- **現状**: `/` がログイン後画面
- **変更後**: `/` がログイン前画面、`/app` がログイン後画面
- **影響**: middleware.tsの大幅な修正が必要

### 3. Python版OCR（タスク6-2）

- **課題**: Cloud Runでのイメージサイズ増加（Tesseractインストール）
- **対策**: マルチステージビルドで最適化
- **コスト**: サーバーサイドOCRによる処理時間・コスト増加

---

## 次回セッション用メモ

### 作業開始時の確認事項

1. 現在のフェーズを確認
2. 前回の作業ログを確認
3. 未完了タスクの状態を確認

### ドキュメント更新

- 各フェーズ完了後、`PROGRESS.md`を更新
- 個別の作業ログを`work_logs/`に作成
- この計画書のステータスを更新

---

**最終更新**: 2025年11月04日
**次回作業**: フェーズ1から開始
